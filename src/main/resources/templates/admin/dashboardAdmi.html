<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrador</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{/css/estilos.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Header -->
    <div th:replace="~{fragmentsAdmi :: header}"></div>

    <div class="container-fluid py-3" style="max-width: 1200px;">
        <div class="row mx-0 justify-content-center">
            <div class="col-12 px-0 mb-4">
                <h2 class="c-primary fw-bold">Dashboard de Administración</h2>
                <p class="text-muted">Vista rápida de indicadores clave y alertas.</p>
            </div>

            <div class="col-12 indicator-cards">
                <div class="indicator-card">
                    <div>
                        <h4>Ventas Hoy</h4>
                        <span>S/. <span th:text="${ventasHoy}">0.00</span></span>
                    </div>
                    <div class="icon-circle"><i class="fas fa-sack-dollar"></i></div>
                </div>
                <div class="indicator-card">
                    <div>
                        <h4>Costo Hoy</h4>
                        <span>S/. <span th:text="${costoHoy}">0.00</span></span>
                    </div>
                    <div class="icon-circle"><i class="fas fa-hand-holding-dollar"></i></div>
                </div>
                <div class="indicator-card">
                    <div>
                        <h4>Margen Bruto</h4>
                        <span>S/. <span th:text="${margenHoy}">0.00</span></span>
                    </div>
                    <div class="icon-circle"><i class="fas fa-chart-line"></i></div>
                </div>
                <div class="indicator-card">
                    <div>
                        <h4>Stock Crítico</h4>
                        <span><span th:text="${#lists.size(stockCritico)}">0</span></span>
                    </div>
                    <div class="icon-circle"><i class="fas fa-triangle-exclamation"></i></div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-6 col-md-12">
                    <div class="chart-container">
                        <h5>Productos Más Vendidos (Última Semana)</h5>
                        <canvas id="topProductosChart"></canvas>
                    </div>
                </div>

                <div class="col-lg-6 col-md-12">
                    <div class="chart-container">
                        <h5>Ventas De la Semana</h5>
                        <canvas id="ventasSemanaChart"></canvas>
                    </div>
                </div>

                <div class="col-lg-6 col-md-12">
                    <div class="table-container">
                        <h5>Insumos en Stock Crítico <i class="fas fa-boxes-stacked text-danger"></i></h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Nombre del Insumo</th>
                                        <th>Stock Actual</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="item : ${stockCritico}" th:if="${!#lists.isEmpty(stockCritico)}"
                                        class="table-danger">
                                        <td th:text="${item.nombre}"></td>
                                        <td th:text="${item.stock_actual}"></td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(stockCritico)}">
                                        <td colspan="2" class="text-center text-muted">No hay insumos en stock crítico.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 col-md-12">
                    <div class="table-container">
                        <h5>Próximos Vencimientos de Lotes <i class="fas fa-calendar-xmark text-warning"></i></h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Lote</th>
                                        <th>Insumo</th>
                                        <th>Vencimiento</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="v : ${vencimientos}">
                                        <td th:text="${v.lote_id}"></td>
                                        <td th:text="${v.insumo}"></td>
                                        <td th:text="${v.fecha_vencimiento}"></td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(vencimientos)}">
                                        <td colspan="3" class="text-center text-muted">No hay próximos vencimientos.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
    <!-- Menú Desplegable -->
    <div th:replace="~{fragmentsAdmi :: menuLateral}"></div>

    <!-- Modales (sin cambios) -->
    <div class="modal fade" id="passwordChangeModal" tabindex="-1">
        <!-- ... (código del modal, sin cambios) -->
    </div>

    <script>
        function togglePassword(inputId, icon) {
            const input = document.getElementById(inputId);
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove("fa-eye");
                icon.classList.add("fa-eye-slash");
            } else {
                input.type = "password";
                icon.classList.remove("fa-eye-slash");
                icon.classList.add("fa-eye");
            }
        }
    </script>

    <script th:inline="javascript">
        let topProductosJson = /*[[${topProductos}]]*/[];
        let ventasSemanaJson = /*[[${ventasSemana}]]*/[];
    </script>
    <script>
        console.log('Datos topProductos:', topProductosJson);
        if (topProductosJson.length > 0) {
            const labels = topProductosJson.map(p => p.nombre);
            const dataValues = topProductosJson.map(p => p.cantidad);
            new Chart(document.getElementById('topProductosChart'), {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Productos más vendidos', data: dataValues, backgroundColor: 'rgba(45, 77, 30, 0.5)', borderColor: '#2d4d1e', borderWidth: 1 }] },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        } else { console.log('No hay datos para topProductos'); }
    </script>
    <script>
        console.log('Datos ventasSemana:', ventasSemanaJson);
        if (ventasSemanaJson.length > 0) {
            const fechas = ventasSemanaJson.map(v => v.fecha);
            const totales = ventasSemanaJson.map(v => v.total);
            new Chart(document.getElementById('ventasSemanaChart'), {  // Actualizado al nuevo ID
                type: 'line',
                data: { labels: fechas, datasets: [{ label: 'Ventas últimos 7 días', data: totales, tension: 0.3, borderColor: '#2d4d1e', backgroundColor: 'rgba(45, 77, 30, 0.1)' }] },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        } else { console.log('No hay datos para ventasSemana'); }
    </script>


</body>

</html>